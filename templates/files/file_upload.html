{% extends 'base_sidebar.html' %} 
{% block title %}Upload File - Creator Backoffice{% endblock %} 
{% block content %}
<div id="view-files-upload" class="view-section">
  <div class="container mt-4">
    <div class="row justify-content-center">
      <div class="col-md-8">
        {% if quota_info %}
        <div class="card mb-3">
          <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-hdd"></i> Google Drive Storage</h5>
          </div>
          <div class="card-body">
            <div class="mb-2">
              <div class="d-flex justify-content-between mb-1">
                <span>Storage Used</span>
                <span
                  ><strong>{{ quota_info.usage_gb|floatformat:2 }} GB</strong>
                  of {{ quota_info.limit_gb|floatformat:2 }} GB</span
                >
              </div>
              <div class="progress" style="height: 25px">
                <div
                  class="progress-bar {% if quota_info.usage_percent > 90 %}bg-danger{% elif quota_info.usage_percent > 75 %}bg-warning{% else %}bg-success{% endif %}"
                  role="progressbar"
                  style="width: {{ quota_info.usage_percent }}%"
                  aria-valuenow="{{ quota_info.usage_percent }}"
                  aria-valuemin="0"
                  aria-valuemax="100"
                >
                  {{ quota_info.usage_percent|floatformat:1 }}%
                </div>
              </div>
            </div>
            <div class="text-muted small">
              <i class="bi bi-info-circle"></i> Available: {{ quota_info.available_gb|floatformat:2 }} GB
            </div>
          </div>
        </div>
        {% endif %}

        <div class="card">
          <div class="card-header">
            <h3 class="mb-0">
              <i class="bi bi-upload"></i> Upload File to Google Drive
              <i
                class="bi bi-info-circle tooltip-icon"
                data-bs-toggle="tooltip"
                data-bs-placement="right"
                title="Upload files up to 5GB to your connected Google Drive"
              ></i>
            </h3>
          </div>
          <div class="card-body">
            <form
              method="post"
              enctype="multipart/form-data"
              id="uploadForm"
              data-loading-message="Uploading file to Google Drive..."
            >
              {% csrf_token %}

              <div class="mb-3">
                <label for="file" class="form-label">
                  Select File
                  <i
                    class="bi bi-info-circle tooltip-icon"
                    data-bs-toggle="tooltip"
                    title="Choose a file to upload. Maximum size: 5GB"
                  ></i>
                </label>
                <input
                  type="file"
                  class="form-control"
                  id="file"
                  name="file"
                  required
                  aria-describedby="fileHelp"
                />
                <div id="fileHelp" class="form-text">
                  <i class="bi bi-info-circle"></i> Maximum single file size:
                  5GB. File size will be validated against available Drive
                  storage.
                </div>
              </div>

              <div class="mb-3" id="fileInfo" style="display: none">
                <div class="alert alert-info">
                  <strong>Selected File:</strong>
                  <ul class="mb-0 mt-2">
                    <li>Name: <span id="fileName"></span></li>
                    <li>Size: <span id="fileSize"></span></li>
                    <li>Type: <span id="fileType"></span></li>
                  </ul>
                </div>
              </div>

              <div class="mb-3" id="quotaWarning" style="display: none">
                <div class="alert alert-warning">
                  <i class="bi bi-exclamation-triangle"></i>
                  <strong>Warning:</strong>
                  <span id="quotaWarningMessage"></span>
                </div>
              </div>

              <div class="d-flex justify-content-between">
                <a href="{% url 'files:file_list' %}" class="btn btn-secondary">
                  <i class="bi bi-arrow-left"></i> Cancel
                </a>
                <button type="submit" class="btn btn-primary" id="uploadBtn">
                  <i class="bi bi-upload"></i> Upload File
                </button>
              </div>
            </form>

            <div id="uploadProgress" class="mt-3" style="display: none">
              <div class="progress" style="height: 30px">
                <div
                  class="progress-bar progress-bar-striped progress-bar-animated"
                  role="progressbar"
                  style="width: 100%"
                >
                  <span class="px-2">Uploading to Google Drive...</span>
                </div>
              </div>
              <div class="text-center mt-2 text-muted">
                <small
                  >Please wait, this may take a few moments depending on file
                  size.</small
                >
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
        const fileInput = document.getElementById('file');
        const fileInfo = document.getElementById('fileInfo');
        const quotaWarning = document.getElementById('quotaWarning');
        const quotaWarningMessage = document.getElementById('quotaWarningMessage');
        const uploadForm = document.getElementById('uploadForm');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadProgress = document.getElementById('uploadProgress');

        // Get quota info from template
        const availableGB = {% if quota_info %}{{ quota_info.available_gb }}{% else %}null{% endif %};
        const maxSingleFileGB = 5; // 5GB Google Drive limit

        // Show file info when file is selected
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileSize').textContent = formatFileSize(file.size);
                document.getElementById('fileType').textContent = file.type || 'Unknown';
                fileInfo.style.display = 'block';

                // Validate file size
                const fileSizeGB = file.size / (1024 * 1024 * 1024);
                let hasError = false;
                let warningMsg = '';

                // Check against single file limit
                if (fileSizeGB > maxSingleFileGB) {
                    warningMsg = `File size (${fileSizeGB.toFixed(2)} GB) exceeds the maximum single file limit of ${maxSingleFileGB} GB.`;
                    hasError = true;
                }
                // Check against available quota
                else if (availableGB !== null && fileSizeGB > availableGB) {
                    warningMsg = `File size (${fileSizeGB.toFixed(2)} GB) exceeds available Drive storage (${availableGB.toFixed(2)} GB).`;
                    hasError = true;
                }

                if (hasError) {
                    quotaWarningMessage.textContent = warningMsg;
                    quotaWarning.style.display = 'block';
                    uploadBtn.disabled = true;
                } else {
                    quotaWarning.style.display = 'none';
                    uploadBtn.disabled = false;
                }
            } else {
                fileInfo.style.display = 'none';
                quotaWarning.style.display = 'none';
                uploadBtn.disabled = false;
            }
        });

        // Show progress on form submit
        uploadForm.addEventListener('submit', function(e) {
            if (uploadBtn.disabled) {
                e.preventDefault();
                return false;
            }
            uploadBtn.disabled = true;
            uploadProgress.style.display = 'block';
        });

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
    });
  </script>
</div>
{% endblock %}
